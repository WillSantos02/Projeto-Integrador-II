<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" href="../css/style_mainTicket/mainTicket.css">
        <link rel="stylesheet" href="../css/style_mainTicket/rechargeModal.css">
        <link rel="stylesheet" href="../css/style_mainTicket/rechargeModalCredit.css">
        <link rel="stylesheet" href="../css/style_mainTicket/rechargeModalPersonalite.css">
        <link rel="stylesheet" href="../css/style_mainTicket/termUseModal.css">
        <link rel="stylesheet" href="../css/style_mainTicket/useTicketModal.css">

        <link rel="stylesheet" href="../css/style_configs/configs.css">
        <link rel="stylesheet" href="../css/style_configs/navbar.css">
        <link rel="stylesheet" href="../css/style_configs/footer.css">
        <link rel="stylesheet" href="../css/style_configs/scrollbar.css">

        <link rel="stylesheet" href="../css/style_recharge/messageModal.css">
        
        <title>FasTICKET: Bem vindo! Aqui você cria, recarrega, utilza, faz o que quiser com seu bilhete.</title>
    </head>

    <body>
        <!-- Navbar -->
        <header>
            <nav>
                <abbr title="Ir para Home">
                    <img class="logo" id="navbar" src="../assets/logo/FASTICKET.svg" alt="Ir para Home" onclick="location.href='../index.html'">
                </abbr>

                <ul class="nav-list">
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="about_ous_view/aboutOus.html">Sobre</a></li>
                    <li><a href="relatorio.html">Relatórios</a></li>
                    <li class="disable">Para empresas</li>
                </ul>

                <ul class="nav-list">
                    <li>
                        <div class="buttons">
                            <button type="button" onclick="location.href='mainTicket.html'" class="btn-nav">
                                Meu bilhete
                            </button>
                        </div>
                    </li>
                </ul>
            </nav>
        </header>
        <!-- Navbar -->

        <main>
            <section>
                <div class="myTicket-container">
                    <div class="myTicket-header">
                        <div class="myTicket-header-title">
                            <h1>Meu Bilhete</h1>
                        </div>
                        <div class="myTicket-header-text">
                            <p>Com o código único você abre muitas portas e vai a lugares inimagináveis!<br><span>Obtenha o seu já!</span></p>
                        </div>
                        <div class="myTicket-header-code">
                            <input id="ticketCode" type="text" placeholder="# Seu código" maxlength="13"> 
                            
                            <button type="button" class="search-btn">
                                <img src="../assets/icons/search_icon.svg" alt="search">
                            </button>

                            <div id="code-message">
                                <span id="message" class="">...</span>
                            </div>
                        </div>
                    </div>

                    <div class="myTicket-content">
                        <div class="myTicket-content-cards">
                            <div class="card">
                                <div class="card-header-icon">
                                    <img src="../assets/icons/create_code_icon.svg"> <hr>
                                </div>
                                <div class="card-header-title">
                                    <h1>Criar código</h1>
                                </div>
                                <div class="card-header-text">
                                    <p>Você ainda não tem um código? Gere agora mesmo!</p>
                                </div>
                                <div class="card-header-button">
                                    <button type="button" class="card-btn" id="codeGenerate"><p>Criar agora</p> <img src="../assets/icons/next_icon.svg"></button>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header-icon">
                                    <img src="../assets/icons/ticket_icon.svg"> <hr>
                                </div>
                                <div class="card-header-title">
                                    <h1>Recarregar</h1>
                                </div>
                                <div class="card-header-text">
                                    <p>Seu bilhete é novo ou acabou? Recarrege agora!</p>
                                </div>
                                <div class="card-header-button">
                                    <button type="button" class="card-btn" id="codeRecharge"><p>Recarregar</p> <img src="../assets/icons/next_icon.svg"></button>
                                </div>
                            </div>

                            <div class="card" id="useCard">
                                <div class="card-header-icon">
                                    <img src="../assets/icons/use_code_icon.svg">
                                </div>
                                <div class="card-header-title">
                                    <h1>Usar bilhete</h1>
                                </div>
                                <div class="card-header-text">
                                    <p>Você vai embarcar em uma viagem incrivel? Use seu bilhete aqui!</p>
                                </div>
                                <div class="card-header-button">
                                    <button type="button" class="card-btn" id="useCode"><p>Usar já</p> <img src="../assets/icons/next_icon.svg"></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
         
        <!-- Footer -->
        <footer>
            <div class="container-footer">
                <nav class="nav-footer">
                    <ul class="nav-list-footer">
                        <li><a href="#navbar">Voltar ao inicio</a></li>
                    </ul>
                </nav>

                <div class="row-footer">
                    <div class="footer-col">
                        <h4>Sobre o FasTICKET</h4>
                        <ul>
                            <li><a href="about_ous_view/aboutOus.html">Sobre nos</a></li>
                            <li><a href="about_ous_view/contact.html">Contato</a></li>
                            <li><a href="about_ous_view/FasTICKET-responsabilities.html">Responsabilidades</a></li>
                            <li><a href="about_ous_view/careers.html">Trabalhe conosco</a></li>
                        </ul>
                    </div>
                    
                    <div class="footer-col">
                        <h4>Bilhetes</h4>
                        <ul>
                            <li><a href="tickets.html">Ações Rápidas</a></li>
                            <li><a href="generate.html">Gerar novo bilhete</a></li>
                            <li><a href="recharge.html">Recarregar bilhete</a></li>
                            <li><a href="mainTicket.html">Utilizar Bilhetes</a></li>
                            <li><a href="relatorio.html">Relatório de uso</a></li>
                            <li><a href="#">Rel. de recarga</a></li>
                        </ul>
                    </div>

                    <div class="footer-col">
                        <h4>Para empresas</h4>
                        <ul>
                            <li><a href="#">FasTICKET e seu negócio</a></li>
                            <li><a href="#">Comprar para sua empresa</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </footer>
        <!-- Footer -->

        <!-- Modal Termo de Uso -->
        <section class="termUse-modal-container" id="termUseModal">
            <div class="termUse-content">
                <div class="termUse-header">
                    <div class="termUse-header-title">
                        <h1>Termo de aceite para criar código único</h1>
                    </div>
                    <div class="termUse-header-icon">
                        <img id="closeModal" src="../assets/icons/close_icon.svg">
                    </div>
                </div>
                
                <div class="termUse-main">
                    <div class="termUse-main-text">
                        <p>Ao aceitar este termo será gerado um código único, onde será possivel recarregar, usar e gerar um relatório de uso. Você pode recarrega-lo várias vezes, sendo armazenadas elas sequencialmente onde uma vez expirada a próxima será ativada automáticamente</p>
                    </div>
                    <div class="termUse-main-button">
                        <button type="button" id="termUseButton" class="termUse-btn" >Aceitar 
                            <img id="btnIcon" src="../assets/icons/arrow_right.svg">
                        </button>
                    </div>
                </div>
            </div>
        </section>
        <!-- Modal Termo de Uso --> 

        <!-- Modal Recarga - Seleção do Bilhete -->
        <section class="recharge-modal-container" id="rechargeModal">
            <div class="recharge-content">
                <div class="recharge-header">
                    <div class="recharge-header-title">
                        <h1>Recarregar seu bilhete</h1>
                        <p>Escolha o tipo do seu bilhete clicando no cartão</p>
                    </div>
                    <div class="recharge-header-icon">
                        <img id="closeModal" src="../assets/icons/close_icon.svg">
                    </div>
                </div>
                
                <div class="recharge-main">
                    <div class="recharge-cards">
                        <img src="../assets/cards/card_personalite.svg" id="cardPersonalite" alt="Cartão Pesonalitè">
                        <img src="../assets/cards/card_creditos.svg" id="cardCredito" alt="Cartão Créditos">
                    </div>

                    <div class="recharge-btn">
                        <button type="button" class="rechagerCancel-btn" id="CancelBtn">Cancelar <img src="../assets/icons/x_icon.svg"></button>
                    </div>
                </div>
            </div>
        </section>
        <!-- Modal Recarga - Seleção do Bilhete -->

        <!-- Modal Recarga - Créditos | Personalite -->
        <section class="credit-modal-container" id="creditModal">
            <div class="credit-content">
                <div class="credit-header">
                    <div class="credit-header-title">
                        <h1>Recarregar seu bilhete</h1>
                    </div>
                    <div class="credit-header-icon">
                        <img id="closeModal" src="../assets/icons/close_icon.svg">
                    </div>
                </div>
                
                <div class="credit-main">
                    <div class="main-text">
                        <p>Utilização ilimitada durante 40 minutos, você pode ter uma ativação ou duas.</p>
                    </div>

                    <div class="main-cards-options">
                        <button type="button" class="option-btn selected" id="CreditOptionBtn">Créditos</button>
                        <button type="button" class="option-btn" id="PersonaliteOptionBtn">Personalitè</button>
                    </div>

                    <div class="main-types">
                        <div class="type-buttons">
                            <button type="button" class="type-btn" id="Unico" data-value="3.26">único</button>
                            <button type="button" class="type-btn" id="Duplo" data-value="6.52">duplo</button>
                        </div>

                        <input type="text" name="valor" class="value-display" id="valorRecarga" readonly placeholder="R$ --">
                    </div>

                    <div class="fun-btn-box">
                        <button type="button" class="fun-btn" id="CancelBtn">Cancelar <img src="../assets/icons/x_icon.svg"></button>
                        <button type="button" class="fun-btn" id="btnRecargaCreditos">Recarregar <img id="btnIcon" src="../assets/icons/arrow_right.svg"></button>
                    </div>
                </div>
            </div>
        </section>

        <section class="personalite-modal-container" id="personaliteModal">
            <div class="personalite-content">
                <div class="personalite-header">
                    <div class="personalite-header-title">
                        <h1>Recarregar seu bilhete</h1>
                    </div>
                    <div class="personalite-header-icon">
                        <img id="closeModal" src="../assets/icons/close_icon.svg">
                    </div>
                </div>
                
                <div class="personalite-main">
                    <div class="personalite-main-text">
                        <p>Utilização ilimitada durante 40 minutos, você pode ter uma ativação ou duas.</p>
                    </div>

                    <div class="personalite-main-cards-options">
                        <button type="button" class="option-btn" id="CreditOptionBtn">Créditos</button>
                        <button type="button" class="option-btn selected" id="PersonaliteOptionBtn">Personalitè</button>
                    </div>

                    <div class="personalite-main-types">
                        <div class="personalite-type-buttons">
                            <button type="button" class="type-btn" id="1d" data-value="10.27">1 dia</button>
                            <button type="button" class="type-btn" id="7d" data-value="71.89">7 dias</button>
                        </div>
                        <div class="personalite-type-buttons">
                            <button type="button" class="type-btn" id="14d" data-value="143.78">14 dias</button>
                            <button type="button" class="type-btn" id="30d" data-value="308.1">30 dias</button>
                        </div>

                        <input type="text" name="valor" class="value-display" id="valorRecarga" readonly placeholder="R$ --">
                    </div>

                    <div class="personalite-fun-btn-box">
                        <button type="button" class="fun-btn" id="CancelBtn">Cancelar <img src="../assets/icons/x_icon.svg"></button>
                        <button type="button" class="fun-btn" id="btnRecargaPersonalite" id="btnIcon">Recarregar <img src="../assets/icons/arrow_right.svg"></button>
                    </div>
                </div>
            </div>
        </section>
        <!-- Modal Recarga - Créditos | Personalite -->

        <!-- Modal de sucesso -->
        <div id="modalMensagemSuccess" style="display: none;">    
            <div class="message-modal-container">
                <div class="message-bar-modal">
                    <h1 class="message-modal-title">Aviso de recargar !</h1>
                </div>
                
                <div class="modal-message">
                    <span>Bilhete recarregado com Sucesso !</span>
                </div>
                
                <div class="message-bottom-modal sucess">
                </div>
            </div>
        </div>
        <!-- Modal de sucesso -->

        <!-- Modal de erro -->
        <div id="modalMensagemError" style="display: none;">    
            <div class="message-modal-container">
                <div class="message-bar-modal">
                    <h1 class="message-modal-title">Aviso de recargar !</h1>
                </div>
                
                <div class="modal-message">
                    <span>Código invalido ou inexistente</span>
                </div>
                
                <div class="message-bottom-modal error">
                </div>
            </div>
        </div>
        <!-- Modal de erro -->

        <!-- Modal Uso -->
        <section class="ticketUse-container" id="ticketUseModal">
            <div class="ticketUse-content">
                <div class="ticketUse-header">
                    <div class="ticketUse-header-title">
                        <h1>Recarregar seu bilhete</h1>
                    </div>
                    <div class="ticketUse-header-icon">
                        <img id="closeModal" src="../assets/icons/close_icon.svg">
                    </div>
                </div>
                
                <div class="ticketUse-main">
                    <div class="ticketUse-main-text">
                        <p>Escolha o meio e o local que você ira viajar com a TRANSCAR.</p>
                    </div>

                    <div class="ticketUse-options">

                        <div class="dropdown">
                            <button onclick="openDropDownMeio()" class="option-dropDown">Meio de Transporte <img src="../assets/icons/dropdown_menu_icon.svg"></button>
                            <div id="dropdownMeio" class="dropdown-content">
                                <a href="#home">Trem</a>
                                <a href="#about">Ônibus</a>
                                <a href="#contact">Metro</a>
                            </div>
                        </div>

                        <div class="dropdown">
                            <button onclick="openDropDownTransporte()" class="option-dropDown">Local <img src="../assets/icons/dropdown_menu_icon.svg"></button>
                            <div id="dropdownTransporte" class="dropdown-content">
                                <a href="#home">Campinas</a>
                                <a href="#about">Sumaré</a>
                                <a href="#contact">Valinhos</a>
                            </div>
                        </div>
                    </div>

                    <div class="ticketUse-fun-btn-box">
                        <button class="fun-btn" id="CancelBtn">Cancelar <img src="../assets/icons/x_icon.svg"></button>
                        <button class="fun-btn" id="btnticketUse" id="btnIcon">Usar <img src="../assets/icons/arrow_right.svg"></button>
                    </div>
                </div>
            </div>
        </section>
        <!-- Modal Uso -->
    </body>

    <!-- Geração do código -->
    <script src="../js/createTicket.js"></script>

    <script>
        function openDropDownMeio() {
            document.getElementById("dropdownMeio").classList.toggle("show");
        }
        
        function openDropDownTransporte() {
            document.getElementById("dropdownTransporte").classList.toggle("show");
        }
    </script>

    <script>
        const createTicketBtn = document.getElementById('termUseButton');
        const ticketCode = document.getElementById('ticketCode');
        const iconButton = document.getElementById("btnIcon");

        createTicketBtn.addEventListener('click', async () => {
            changeImage();

            let newTicketCode = await createTicket();

            console.log(newTicketCode)

            ticketCode.value = newTicketCode.TICKET_ID || newTicketCode.error;

            setTimeout(() => {
                geracaoCodigoModal.style.display = "none";
                iconButton.src = iconButton.src.replace("loader.svg", "arrow_right.svg");
            }, await createTicket())
        })

        function changeImage() {
            iconButton.src = iconButton.src.replace("arrow_right.svg", "loader.svg");
            // console.log(iconButton.src)
        }
    </script>
    <!-- Geração do código -->

    <script>
        const geracaoCodigoModal = document.getElementById('termUseModal');
        const selecTypeRechargeModal = document.getElementById('rechargeModal');
        const creditModal = document.getElementById('creditModal');
        const personaliteModal = document.getElementById('personaliteModal');

        function abrirModalTermoGeracao(){
            geracaoCodigoModal.style.display = "flex";
            
            geracaoCodigoModal.addEventListener('click', (e) => {

                if(e.target.id == 'termUseModal' || 
                    e.target.id == 'codeGenerate' || 
                    e.target.id == "closeModal"){
                    geracaoCodigoModal.style.display = "none";
                }
            });
        }

        function abrirModalRecarga(){
            selecTypeRechargeModal.style.display = "flex";

            selecTypeRechargeModal.addEventListener('click', (e) => {
                if(e.target.id == 'rechargeModal' || 
                    e.target.id == 'codeRecharge' || 
                    e.target.id == 'closeModal' || 
                    e.target.id == 'CancelBtn'){
                    selecTypeRechargeModal.style.display = "none";
                } 
            });
        }

        function abrirModalCredito(){
            creditModal.style.display = "flex";
            selecTypeRechargeModal.style.display = "none";

            creditModal.addEventListener('click', (e) => {
                if(e.target.id == 'creditModal' ||
                    e.target.id == 'closeModal' ||
                    e.target.id == 'CancelBtn' ||
                    e.target.id == 'PersonaliteOptionBtn'){
                    creditModal.style.display = "none";
                }
            });

            buttonsCreditos.forEach(buttonF => {
                if (buttonF.classList.contains('btn-selected')){
                    buttonF.classList.remove('btn-selected')
                }
            })

            valorRecarga.forEach(input => {
                input.placeholder = "R$10.00"
            })
        }

        function abrirModalPersonalite(){
            personaliteModal.style.display = "flex";
            selecTypeRechargeModal.style.display = "none";

            personaliteModal.addEventListener('click', (e) => {
                if(e.target.id == 'personaliteModal' ||
                    e.target.id == 'closeModal' ||
                    e.target.id == 'CancelBtn'){
                    personaliteModal.style.display = "none";
                }
            })
            
            buttonsCreditos.forEach(buttonF => {
                if (buttonF.classList.contains('btn-selected')){
                    buttonF.classList.remove('btn-selected')
                }
            })

            valorRecarga.forEach(input => {
                input.placeholder = "R$10.00"
            })
        }

        const openGeracao = document.querySelector('#codeGenerate');
        openGeracao.addEventListener('click', () => abrirModalTermoGeracao('termUseModal'));

        const openRecharge = document.querySelector('#codeRecharge');
        openRecharge.addEventListener('click', () => abrirModalRecarga('rechargeModal'));

        const openCredit = document.querySelector('#cardCredito');
        openCredit.addEventListener('click', () => abrirModalCredito('creditModal'));

        const openPersonalite = document.querySelector('#cardPersonalite');
        openPersonalite.addEventListener('click', () => abrirModalPersonalite('personaliteModal'));

        //- - - - - - - //
        const buttonsCreditos = document.querySelectorAll('.type-btn')
        const valorRecarga = document.querySelectorAll('#valorRecarga')

        buttonsCreditos.forEach(button => {
            button.addEventListener('click', () => {
                button.classList.add('btn-selected')

                buttonsCreditos.forEach(buttonF => {
                    if (buttonF != button){
                        if (buttonF.classList.contains('btn-selected')){
                            buttonF.classList.remove('btn-selected')
                        }
                    }
                })

                valorRecarga.forEach(input => {
                    input.placeholder = `R$ ${button.dataset.value}`
                })
            })
        })

        //- - - - -//
        const btnPersonalite = document.getElementById('btnRecargaPersonalite')
        const btnCreditos = document.getElementById('btnRecargaCreditos')

        const modalMensagemSuccess = document.getElementById('modalMensagemSuccess')
        const modalMensagemError = document.getElementById('modalMensagemError')

        const ticketCodeInput = document.getElementById('ticketCode')

        btnPersonalite.addEventListener('click', async () => {
            if (ticketCodeInput.value != '')
            {//tem algo digitado
                const btnSelect = document.querySelectorAll('.btn-selected')

                if (btnSelect.length != 0)
                {
                    const response = await fetch('http://localhost:8080/recharges', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ticket: ticketCodeInput.value,
                            type: btnSelect[0].id
                        }
                    }).then(res => res.json()).then(res=>res)

                    exibeModal(response.status);
                }
            }
        })

        btnCreditos.addEventListener('click', async () => {
            if (ticketCodeInput.value != '')
            {//tem algo digitado
                const btnSelect = document.querySelectorAll('.btn-selected')

                if (btnSelect.length != 0)
                {
                    const response = await fetch('http://localhost:8080/recharges', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ticket: ticketCodeInput.value,
                            type: btnSelect[0].id
                        }
                    }).then(res => res.json()).then(res=>res)
                    
                    exibeModal(response.status);
                }
            }
        })

        function exibeModal (status) {
            //alert(response.message);
            if(status == 'success'){
                modalMensagemSuccess.style.display = 'flex';
                personaliteModal.style.display = "none";
                creditModal.style.display = "none";
                //console.log('entrou no if');
                
                setTimeout(() => {
                    modalMensagemSuccess.style.display = 'none';
                    //consollog('entrou no setTimeout');
                }, 5000);
            } else {
                modalMensagemError.style.display = 'flex';
                personaliteModal.style.display = "none";
                creditModal.style.display = "none";
                //nsole.log('entrou no else');

                setTimeout(() => {
                    modalMensagemError.style.display = 'none';
                    // consollog('entrou no setTimeout');
                }, 5000);
            }
        }
    </script>
</html>